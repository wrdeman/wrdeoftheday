<!DOCTYPE html>
<html>

    <head>
        <title> Average House Prices &middot; Wrde Of The Day </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.57.2" />


<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://www.wrdeoftheday.co.uk/css/nix.css">





<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://www.wrdeoftheday.co.uk>wrde@man ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://www.wrdeoftheday.co.uk">/home/wrde</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/about">~/about</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="/post">~/post</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://www.wrdeoftheday.co.uk/post/average-house-prices/">Average House Prices</a></h1>
            <span class="post-date">Jan 28, 2019 </span>
            <div class="post-content">
                

<h3 id="what-s-the-average-house-price-in-a-school-s-catchment-area">What&rsquo;s the average house price in a school&rsquo;s catchment area?</h3>

<p>In order to calculate the average house price in a school&rsquo;s catchment area, we are going to use PostGIS and OpenStreetMap. We&rsquo;ll need to know the price and location of houses sold in that area, and the location of the schools and it&rsquo;s catchment area. The former can be determined from the land registry and although this does not provide any geocoding we can do this using data provided by OpenStreetMap&rsquo;s Nominatim. The location of the schools can be found in OpenStreetMap&rsquo;s polygon table.</p>

<p>In this example we are using <code>MYTOWN</code> and <code>SCHOOL NAME</code> as aliases.</p>

<h4 id="openstreetmap">OpenStreetMap</h4>

<p>There are good instructions on how to setup OpenStreetMap <a href="https://switch2osm.org/manually-building-a-tile-server-18-04-lts/">here</a> and I recommend following these.</p>

<h4 id="postcodes">Postcodes</h4>

<p>For the postcode data, first get the data:</p>

<pre><code class="language-bash">wget https://www.nominatim.org/data/gb_postcode_data.sql.gz
gunzip gb_postcode_data.sql.gz
</code></pre>

<p>Create a PostGIS table for the postcode data noting that it uses the EPSG:4326 projection.</p>

<pre><code class="language-sql">CREATE TABLE gb_postcode (
    id integer,
    postcode character varying(9),
    geometry geometry,
    CONSTRAINT enforce_dims_geometry CHECK ((st_ndims(geometry) = 2)),
    CONSTRAINT enforce_srid_geometry CHECK ((st_srid(geometry) = 4326))
);
</code></pre>

<p>Then ingest the data as follows:</p>

<pre><code class="language-bash">psql -dgis -f data/gb_postcode_data.sql
</code></pre>

<h4 id="house-prices">House prices.</h4>

<p>UK house prices are recorded by the Land Registry and they have a nice SPARQL console interface <a href="http://landregistry.data.gov.uk/app/qonsole">http://landregistry.data.gov.uk/app/qonsole</a>. Here we get the house prices for properties in MYTOWN in 2018 using the following SPARQL query:</p>

<pre><code>prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
prefix owl: &lt;http://www.w3.org/2002/07/owl#&gt;
prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt;
prefix sr: &lt;http://data.ordnancesurvey.co.uk/ontology/spatialrelations/&gt;
prefix ukhpi: &lt;http://landregistry.data.gov.uk/def/ukhpi/&gt;
prefix lrppi: &lt;http://landregistry.data.gov.uk/def/ppi/&gt;
prefix skos: &lt;http://www.w3.org/2004/02/skos/core#&gt;
prefix lrcommon: &lt;http://landregistry.data.gov.uk/def/common/&gt;

SELECT ?paon ?saon ?street ?town ?county ?postcode ?amount ?date ?category
WHERE
{
  VALUES ?town {&quot;MYTOWN&quot;^^xsd:string}
FILTER (
    ?date &gt; &quot;2018-01-01&quot;^^xsd:date &amp;&amp;
    ?date &lt; &quot;2018-12-31&quot;^^xsd:date
  )
  ?addr lrcommon:town ?town.

  ?transx lrppi:propertyAddress ?addr ;
          lrppi:pricePaid ?amount ;
          lrppi:transactionDate ?date ;
          lrppi:transactionCategory/skos:prefLabel ?category.

  OPTIONAL {?addr lrcommon:county ?county}
  OPTIONAL {?addr lrcommon:paon ?paon}
  OPTIONAL {?addr lrcommon:saon ?saon}
  OPTIONAL {?addr lrcommon:street ?street}
  OPTIONAL {?addr lrcommon:postcode ?postcode}

}
ORDER BY ?amount
</code></pre>

<p>To get the housing data into PostGIS we first create a table for the house prices, the copy the data from a csv, and finally copy the appropriate postcode geometry onto the house table. This is a bit of a shortcut cut to make subsequent lookups easier as we could have made a foreign key relation between the house and postcode tables.</p>

<pre><code class="language-sql">CREATE TABLE house (
    postcode character varying(9),
    geometry geometry,
    paon varchar(40),
    saon  varchar(40),
    street varchar(40),
    town varchar(40),
    county varchar(40),
    postcode varchar(11) 
    amount integer,
    date date,
    category varchar(40)
);
</code></pre>

<p>Copy the postcode geometry onto the house table</p>

<pre><code class="language-sql">UPDATE house 
SET geometry=gb_postcode.geometry 
FROM gb_postcode WHERE gb_postcode.postcode LIKE house.postcode;
</code></pre>

<p>The final thing to do is to transform the data to transform the postcode table to have the same projection as the OpenStreetMap tables.</p>

<pre><code class="language-sql">ALTER TABLE house 
ALTER COLUMN geometry TYPE geometry(point, 3857) 
USING ST_Transform(ST_SETSRID(geometry,4326),3857);
</code></pre>

<p>In <a href="https://qgis.org/en/site/">QGIS</a> we can plot the houses sold in MYTOWN in the 2018:
<img src="/images/all_points.png" alt="All houses 2018" /></p>

<h4 id="filtering-sold-houses-around-a-school">Filtering sold houses around a school</h4>

<p>Now we have OpenStreetMap and a table of houses we can find the houses within a distance of a school. The schools location is found from the <code>planet_osm_polygon</code> table and it is easy enough as <code>SELECT ST_CENTROID(way) FROM planet_osm_polygon WHERE name ILIKE '%SCHOOL NAME'</code>. This query finds the polygon representing the school (note you may need to add an extra clause <code>amenity LIKE 'school'</code>) and the PostGIS function ST_CENTROID finds the centre of the polygon. The filter we need to apply to the house table is `WHERE ST_DWITHIN(POINT1, POINT2, DISTANCE) where POINT1 is the centre of the scool, POINT2 is the point of the house (geometry field on the house table) and DISTANCE is the permitted distance in metres. In the following example, I have chose 800m as this was the radius of the catchment area in 2018.</p>

<p>Again using QGIS we can apply then following filter to the house table we find the houses sold within a 800m radius of the school.</p>

<pre><code class="language-sql">WHERE ST_DWITHIN(
    (
        SELECT ST_CENTROID(way) 
        FROM planet_osm_polygon 
        WHERE name ILIKE '%SCHOOL NAME%'
    ), 
    geometry, 
    800
);
</code></pre>

<p><img src="/images/select_points.png" alt="Houses within 800m of location 2018" /></p>

<p>Finally we are in a position to calculate the average house price.</p>

<pre><code class="language-sql">SELECT min(h.amount), avg(h.amount), max(h.amount) 
FROM house as h 
WHERE ST_DWITHIN(
    (
        SELECT ST_CENTROID(way) 
        FROM planet_osm_polygon 
        WHERE name ILIKE '%SCHOOL NAME%'
    ), 
    h.geometry, 
    800
);
</code></pre>

<pre><code class="language-sql">gis=# SELECT MIN(h.amount), AVG(h.amount), MAX(h.amount) 
    FROM house h 
    LEFT JOIN planet_osm_polygon pa ON ST_DWITHIN(ST_CENTROID(pa.way), h.geometry, 800) 
    WHERE pa.name ILIKE '%SCHOOL NAME%';

  min   |         avg         |  max   
--------+---------------------+--------
 220000 | 581765.051724137931 | 988200
(1 row)

Time: 641.007 ms

gis=# SELECT MIN(h.amount), AVG(h.amount), MAX(h.amount) 
    FROM house as h 
    WHERE ST_Dwithin(
        (SELECT ST_CENTROID(way) FROM planet_osm_polygon WHERE name ILIKE '%SCHOOL NAME%'), 
        h.geometry, 
        800
    );

  min   |         avg         |  max   
--------+---------------------+--------
 220000 | 581765.051724137931 | 988200

(1 row)

Time: 644.310 ms
</code></pre>

            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 wrde of the day -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

    </body>
