<!DOCTYPE html>
<html>

    <head>
        <title> Django Benchmark &middot; Wrde Of The Day </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.57.2" />


<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://www.wrdeoftheday.co.uk/css/nix.css">





<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://www.wrdeoftheday.co.uk>wrde@man ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://www.wrdeoftheday.co.uk">/home/wrde</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/about">~/about</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="/post">~/post</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://www.wrdeoftheday.co.uk/post/django-benchmark/">Django Benchmark</a></h1>
            <span class="post-date">Feb 2, 2019 </span>
            <div class="post-content">
                

<h2 id="concurrency-django-and-apache-bench">Concurrency, Django and Apache Bench</h2>

<p>The motivation for this blog was as a starting point in debugging errors caused errors caused by concurrency or race conditions - the so-called <a href="https://en.wikipedia.org/wiki/Heisenbug">Heisenbug</a>. I am going to use a contrived example of a bank account with a method to withdraw money and record each transaction. Then I will make a number of concurrent requests and investigate any undesired effects. I do not, in this blog, seek to propose any solution to these effects - solely to provide a means of determining whether they are present.</p>

<p>The app for this demo can be found <a href="https://github.com/wrdeman/demo-concurrency">here</a>.</p>

<h3 id="django-app">Django App</h3>

<p>For this task I will use a simple Django App with Session Authentication, a GET endpoint for retrieving the account balance, and a POST endpoint for making a withdrawl. I have chosen to use a POST request for the withdrawl method to illustrate how to use Apache Bench (Ab) with cookies.</p>

<h4 id="models">Models</h4>

<p>The simple account model is associated to a user, has a minimum and the current balance. The transaction model is used as a record the balance at each transaction from the account.</p>

<pre><code class="language-Python">from django.contrib.auth.models import User                                    
from django.db import models                                                   
                                                                               
                                                                               
class Account(models.Model):                                                   
    user = models.ForeignKey(User, models.SET_NULL, null=True, blank=True)     
    minimum = models.IntegerField(default=0)                                 
    current = models.IntegerField(default=1000000)                             
                                                                              
    def make_withdrawl(self, value=1):                                         
        if self.current &gt;= self.minimum:                                     
            self.current -= value                                              
            self.save()                                                        
        return self.current                                                    
                                                                              
                                                                               
class Transaction(models.Model):                                               
    holder = models.ForeignKey(Account, models.SET_NULL, null=True, blank=True)
    transaction = models.IntegerField()                                        
    balance = models.IntegerField()                                        
</code></pre>

<h4 id="views">Views</h4>

<p>The views are really basic. The GET simply returns the current balance. The POST makes a withdrawl (default 1) and then creates the transaction.</p>

<pre><code>
from django.http import HttpResponse                                           
from django.views import View                                                  
from .models import Account, Transaction                                       
                                                                               
                                                                                          
class WithdrawView(View):                                                         
    def get(self, request, *args, **kwargs):                                   
        if request.user.is_authenticated:                                      
            holder = Account.objects.filter(user=request.user).first()         
            current = holder.current                                            
            return HttpResponse(current)                                                       
        return HttpResponse(&quot;&quot;)                                                
                                                                               
    def post(self, request, *args, **kwargs):                                                    
        holder = Account.objects.filter(user=request.user).first()             
        current = holder.make_withdrawl()                                      
        Transaction.objects.create(                                            
            holder=holder,                                                     
            transaction=current                                                
        )                                                                      
        return HttpResponse(current)
</code></pre>

<h4 id="django-and-gunicorn">Django and Gunicorn</h4>

<p>For this type of experiment, it is probably best to run Django as you would in production, using a WSGI HTTP server such as Gunicorn. Whilst Django&rsquo;s built in runserver is by default multithreaded, it seems prudent to keep the system close to that of a production system.</p>

<h3 id="benchmark">Benchmark</h3>

<p>As described above, I have decided to have the withdrawl endpoint as an POST request. This means that I need to get CSRF tokens and session ids before using Ab. These commands are all contained in the script <code>splatter.sh</code>.</p>

<h4 id="cookies">Cookies</h4>

<p>First we GET the login page and save the cookies to a file:</p>

<pre><code>curl -c cookies.txt -XGET http://localhost:8001/auth/login/ 2&gt;&amp;1               
</code></pre>

<p>Then grab the CSRF token from the cookies as so</p>

<pre><code>CSRF=$(cat cookies.txt | grep csrftoken | awk -F&quot; &quot; '{print $7}')              
</code></pre>

<p>Using the token we can login saving a new cookies file, which now includes the sessionid:</p>

<pre><code>curl -i --cookie cookies.txt -H &quot;X-CSRFToken:&quot;$CSRF&quot;&quot; -H&quot;Content-Type: application/x-www-form-urlencoded&quot; -X POST -d &quot;username=$UNAME&quot; -d &quot;password=$PWORD&quot; http://localhost:8001/auth/login/ -c new_cookies.txt
</code></pre>

<p>As with the CSRF token we can grab the sessionid:</p>

<pre><code>SESSION=$(cat new_cookies.txt | grep session | awk -F&quot; &quot; '{print $7}')         
</code></pre>

<h4 id="benchmark-1">Benchmark</h4>

<p>Now done to the serious business of using Ab to make a number of concurrent requests. This will make a total of 100 requests (<code>-n 100</code>) with 3 concurrent requests (<code>-c 3</code>). Note that I had to combine my cookies together separated with a semicolon.</p>

<pre><code>ab -n 100 -c 3 -C &quot;sessionid=$SESSION;csrftoken=$CSRF&quot; -H &quot;X-CSRFToken:$CSRF&quot; -T&quot;Content-Type: application/json&quot; -mPOST http://localhost:8001/accounts/withdraw/
</code></pre>

<p>What does this tell us? First, we have created 100 transactions (<code>Transaction.objects.count()</code>). Second, the current value on the Account model is only 999953 where as you&rsquo;d hope after 100 withdrawls of value 1 you&rsquo;d be at 999900. We can count the number of single transactions by grouping the transactions by balance and aggregating, as follows:</p>

<pre><code class="language-python">Transaction.objects.values(&quot;balance&quot;).annotate(count=Count(&quot;id&quot;)).aggregate(Count(&quot;count&quot;)) 
</code></pre>

<p>which evaluates, in this case, to 47. No suprises there.</p>

<h3 id="finally">Finally &hellip;</h3>

<p>So there we have it. We can use Apache Bench to make a number of concurrent HTTP requests and observe it&rsquo;s effect on out application.</p>

            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 wrde of the day -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

    </body>
